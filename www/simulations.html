<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="generator" content="pandoc">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
  <meta name="author" content="Patrick Brown, Paul Nguyen">
  <title>High resolution Local-EM Example with Kentucky</title>
  <style type="text/css">code{white-space: pre;}</style>
  <style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
  </style>
  <link rel="stylesheet" href="/home/patrick/R/x86_64-pc-linux-gnu-library/3.4/Pmisc/src/article.css">
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
  
  
  
</head>
<body>
<header>
<h1 class="title">High resolution Local-EM Example with Kentucky</h1>
<p class="author">Patrick Brown, Paul Nguyen</p>
<p class="date">Wednesday 12 July 2017</p>
</header>
<h2 id="introduction">Introduction</h2>
<p>The <code>localEM</code> package contains functions to implement the kernel smoothing local-EM algorithm<span class="math inline"><em></em><sup>1</sup></span> of disease data aggregated to geographical regions. This algorithm provides an nonparametric alternative to the standard geospatial models, such as the Besag-York-Mollie (BYM) model<span class="math inline"><em></em><sup>2</sup></span>, for estimating spatial risk of areal disease data. With disease cases typically aggregated to highly coarse geographical regions (e.g., census counties, or census subdivisions), the local-EM method creates a tessellation of distinct regions by overlaying the map of these coarse regions with another map containing fine geographical regions (e.g., census tracts, census blocks, or census dissemination areas) of population data. This allows for the spatial risk to be estimated at a better resolution with the fine regions.</p>
<p>The methodology of this package is demonstrated on simulated lung cancer cases for the state of Kentucky, USA. The spatial polygons for the census counties and tracts of Kentucky are included with this package.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># specify number of grid cells and</span>
<span class="co"># number of cores for computations in parallel </span>
<span class="cf">if</span>(<span class="kw">any</span>(<span class="kw">commandArgs</span>()<span class="op">==</span><span class="st">&#39;highRes&#39;</span> <span class="op">|</span><span class="st"> </span><span class="kw">basename</span>(<span class="kw">getwd</span>())<span class="op">==</span><span class="st">&#39;www&#39;</span>) ) {
  <span class="co"># this uses about 20GB of memory</span>
  cellsFine =<span class="st"> </span><span class="dv">400</span>
  cellsSimulate =<span class="st"> </span><span class="dv">600</span>
  cellsCoarse=<span class="dv">20</span>
  nsim =<span class="st"> </span><span class="dv">20</span>
  nxv =<span class="st"> </span><span class="dv">12</span>
  path =<span class="st"> </span><span class="kw">paste</span>(<span class="st">&#39;/store/&#39;</span>, <span class="kw">Sys.info</span>()[<span class="st">&#39;user&#39;</span>], <span class="st">&#39;/localem/highRes&#39;</span>,<span class="dt">sep=</span><span class="st">&#39;&#39;</span>)
  Sbw =<span class="st"> </span><span class="kw">unique</span>(<span class="kw">round</span>(<span class="kw">exp</span>(<span class="kw">seq</span>(<span class="kw">log</span>(<span class="dv">5</span>), <span class="kw">log</span>(<span class="dv">50</span>), <span class="dt">len=</span><span class="dv">15</span>)))) <span class="op">*</span><span class="st"> </span><span class="dv">1000</span>
  knitr<span class="op">::</span>opts_chunk<span class="op">$</span><span class="kw">set</span>(<span class="dt">dpi =</span> <span class="dv">200</span>)
  <span class="co"># number of cores set to total available, min 2, max 32</span>
  <span class="cf">if</span>(.Platform<span class="op">$</span>OS.type <span class="op">==</span><span class="st"> &#39;unix&#39;</span>)
    ncores =<span class="st"> </span><span class="kw">pmin</span>(<span class="dv">32</span>, parallel<span class="op">::</span><span class="kw">detectCores</span>() )
} <span class="cf">else</span> {
  <span class="co"># a less computationally intensive setup</span>
  ncores =<span class="st"> </span><span class="dv">2</span>
  cellsFine =<span class="st"> </span><span class="dv">100</span>
  cellsSimulate =<span class="st"> </span><span class="dv">200</span>
  cellsCoarse=<span class="st"> </span><span class="dv">8</span>
  nsim =<span class="st"> </span><span class="dv">3</span>
  nxv =<span class="st"> </span><span class="dv">4</span>
  <span class="co"># on unix systems results will be saved in /tmp/localEMusername</span>
  path =<span class="st"> </span><span class="kw">file.path</span>(<span class="kw">dirname</span>(<span class="kw">tempdir</span>()),  <span class="kw">paste</span>(<span class="st">&#39;localEM&#39;</span>, <span class="kw">Sys.info</span>()[<span class="st">&#39;user&#39;</span>], <span class="dt">sep=</span><span class="st">&#39;&#39;</span>))
  Sbw =<span class="st"> </span><span class="kw">seq</span>(<span class="dv">10</span>,<span class="dv">30</span>,<span class="dt">by=</span><span class="dv">10</span>) <span class="op">*</span><span class="st"> </span><span class="dv">1000</span>
}
<span class="cf">if</span>(<span class="op">!</span><span class="kw">requireNamespace</span>(<span class="st">&quot;RandomFields&quot;</span>, <span class="dt">quietly=</span><span class="ot">TRUE</span>)) {
  cellsSimulate =<span class="st"> </span><span class="dv">100</span>
}

<span class="kw">dir.create</span>(path, <span class="dt">showWarnings =</span> <span class="ot">FALSE</span>, <span class="dt">recursive =</span> <span class="ot">TRUE</span>)
<span class="kw">dir.create</span>(<span class="st">&#39;cache&#39;</span>, <span class="dt">showWarnings =</span> <span class="ot">FALSE</span>, <span class="dt">recursive =</span> <span class="ot">TRUE</span>)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(<span class="st">&#39;mapmisc&#39;</span>)</code></pre></div>
<pre><code>## Loading required package: sp</code></pre>
<pre><code>## Loading required package: raster</code></pre>
<pre><code>## map images will be cached in  /tmp/mapmiscCache_patrick</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">data</span>(<span class="st">&#39;kentuckyCounty&#39;</span>, <span class="dt">package =</span> <span class="st">&#39;localEM&#39;</span>) 
<span class="kw">data</span>(<span class="st">&#39;kentuckyTract&#39;</span>, <span class="dt">package =</span> <span class="st">&#39;localEM&#39;</span>) 
<span class="kw">data</span>(<span class="st">&#39;kMap&#39;</span>, <span class="dt">package =</span> <span class="st">&#39;localEM&#39;</span>)</code></pre></div>
<h2 id="simulate-cases">Simulate Cases</h2>
<p>Using the <code>simLgcp()</code> function from the <code>geostatsp</code> package, case locations are simulated with the log Gaussian Cox process and following parameters:</p>
<ul>
<li>mean: 0</li>
<li>variance: 0.16</li>
<li>shape: 2</li>
<li>range: 120 km</li>
<li>offsets: log of expected cases/m<span class="math inline"><em></em><sup>2</sup></span> of the census tracts</li>
</ul>
<p>The simulated cases are then aggregated to the appropriate counties.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">kentuckyOffset =<span class="st"> </span>geostatsp<span class="op">::</span><span class="kw">spdfToBrick</span>(
    kentuckyTract,
    geostatsp<span class="op">::</span><span class="kw">squareRaster</span>(kentuckyTract, cellsSimulate),
    <span class="dt">pattern =</span> <span class="st">&#39;^expected$&#39;</span>,
    <span class="dt">logSumExpected =</span> <span class="ot">TRUE</span>
)

<span class="kw">set.seed</span>(<span class="dv">0</span>)
kCases =<span class="st"> </span>geostatsp<span class="op">::</span><span class="kw">simLgcp</span>(
    <span class="dt">param =</span> <span class="kw">c</span>(<span class="dt">mean =</span> <span class="dv">0</span>, <span class="dt">variance =</span> <span class="fl">0.4</span><span class="op">^</span><span class="dv">2</span>, <span class="dt">range =</span> <span class="dv">120</span> <span class="op">*</span><span class="st"> </span><span class="dv">1000</span>, <span class="dt">shape =</span> <span class="dv">2</span>),
    <span class="dt">covariates =</span> <span class="kw">list</span>(<span class="dt">logExpected =</span> kentuckyOffset), 
    <span class="dt">offset =</span> <span class="st">&#39;logExpected&#39;</span>, <span class="dt">n=</span>nsim)</code></pre></div>
<pre><code>## ....................</code></pre>
<p>Aggregate events to counties</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">kCases<span class="op">$</span>agg =<span class="st"> </span><span class="kw">lapply</span>(
    kCases[<span class="kw">grep</span>(<span class="st">&#39;^events[[:digit:]]+?&#39;</span>, <span class="kw">names</span>(kCases))],
    <span class="cf">function</span>(qq) <span class="kw">over</span>(qq, kentuckyCounty)[,<span class="st">&#39;id&#39;</span>]
)
countyCounts =<span class="st"> </span><span class="kw">as.data.frame</span>(<span class="kw">lapply</span>(
        kCases<span class="op">$</span>agg,  
        <span class="cf">function</span>(xx) <span class="kw">as.vector</span>(<span class="kw">table</span>(xx, <span class="dt">exclude =</span> <span class="ot">NULL</span>)[<span class="kw">as.character</span>(kentuckyCounty<span class="op">$</span>id)])
    ))
countyCounts[<span class="kw">is.na</span>(countyCounts)] =<span class="st"> </span><span class="dv">0</span>
<span class="kw">names</span>(countyCounts) =<span class="st"> </span><span class="kw">gsub</span>(<span class="st">&#39;^events&#39;</span>, <span class="st">&#39;count&#39;</span>, <span class="kw">names</span>(countyCounts))
<span class="kw">rownames</span>(countyCounts) =<span class="st"> </span><span class="kw">as.character</span>(kentuckyCounty<span class="op">$</span>id)
kentuckyCounty =<span class="st"> </span><span class="kw">merge</span>(kentuckyCounty, countyCounts, <span class="dt">by.x =</span> <span class="st">&#39;id&#39;</span>, <span class="dt">by.y =</span> <span class="st">&#39;row.names&#39;</span>)</code></pre></div>
<div id="fig:plotOffset" class="subfigures">
<table style="width:90%;">
<colgroup>
<col style="width: 45%" />
<col style="width: 45%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><figure>
<img src="figure/plotOffset-1.png" alt="a) Offset" style="width:100.0%" /><figcaption>a) Offset</figcaption>
</figure></td>
<td style="text-align: center;"><figure>
<img src="figure/plotOffset-2.png" alt="b) Relative Intensity" style="width:100.0%" /><figcaption>b) Relative Intensity</figcaption>
</figure></td>
</tr>
<tr class="even">
<td style="text-align: center;"><figure>
<img src="figure/plotOffset-3.png" alt="c) Events" style="width:100.0%" /><figcaption>c) Events</figcaption>
</figure></td>
<td style="text-align: center;"><figure>
<img src="figure/plotOffset-4.png" alt="d) Counts" style="width:100.0%" /><figcaption>d) Counts</figcaption>
</figure></td>
</tr>
</tbody>
</table>
<p><em>Figure 1</em>: Simulated Events</p>
</div>
<h1 id="estimation">Estimation</h1>
<p>The first simulated dataset</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(<span class="st">&#39;localEM&#39;</span>)
fileHere =<span class="st"> </span><span class="kw">file.path</span>(path, <span class="st">&#39;xvKentucky.RData&#39;</span>)

<span class="cf">if</span>(<span class="op">!</span><span class="kw">file.exists</span>(fileHere)) {
  xvKentucky =<span class="st"> </span><span class="kw">lemXv</span>(
      <span class="dt">cases =</span> kentuckyCounty[,<span class="kw">c</span>(<span class="st">&#39;id&#39;</span>,<span class="st">&#39;count1&#39;</span>)],   
      <span class="dt">population =</span> kentuckyTract,   
      <span class="dt">cellsCoarse =</span> cellsCoarse,   
      <span class="dt">cellsFine =</span> cellsFine,   
      <span class="co">#     lemObjects = readRDS(file.path(path, &#39;smoothingMatrix.rds&#39;)),</span>
      <span class="dt">bw =</span> Sbw,
      <span class="dt">xv =</span> nxv, 
      <span class="dt">ncores =</span> ncores,
      <span class="dt">path =</span> path,
      <span class="dt">verbose =</span> <span class="ot">TRUE</span>)
  <span class="kw">save</span>(xvKentucky, <span class="dt">file=</span>fileHere)  
} <span class="cf">else</span> {
  <span class="kw">load</span>(fileHere)  
}</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(xvKentucky<span class="op">$</span>xv[,<span class="dv">1</span>]<span class="op">/</span><span class="dv">1000</span>, xvKentucky<span class="op">$</span>xv[,<span class="dv">2</span>], 
    <span class="dt">xlab =</span><span class="st">&#39;km&#39;</span>, <span class="dt">ylab =</span> <span class="st">&#39;-log p&#39;</span>, 
    <span class="dt">type =</span> <span class="st">&#39;o&#39;</span>
)</code></pre></div>
<div id="fig:cvPlotNew" class="subfigures">
<table style="width:80%;">
<colgroup>
<col style="width: 80%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><figure>
<img src="figure/cvPlotNew-1.png" alt="a) Cross Validation Scores" style="width:100.0%" /><figcaption>a) Cross Validation Scores</figcaption>
</figure></td>
</tr>
</tbody>
</table>
<p><em>Figure 2</em>: Cross Validation Scores</p>
</div>
<h1 id="risk-estimation">Risk Estimation</h1>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">riskEst =<span class="st"> </span><span class="kw">levels</span>(xvKentucky<span class="op">$</span>risk)[[<span class="dv">1</span>]]
toPlot =<span class="st"> </span>xvKentucky<span class="op">$</span>risk

<span class="cf">for</span>(Dbw <span class="cf">in</span> xvKentucky<span class="op">$</span>xv<span class="op">$</span>bw) {
  
  rCol =<span class="st"> </span>mapmisc<span class="op">::</span><span class="kw">colourScale</span>(
      riskEst[,<span class="kw">paste</span>(<span class="st">&#39;bw&#39;</span>, Dbw, <span class="st">&#39;_count1&#39;</span>, <span class="dt">sep=</span><span class="st">&#39;&#39;</span>) ], 
      <span class="dt">breaks =</span> iCol<span class="op">$</span>breaks,
      <span class="dt">style =</span> <span class="st">&#39;fixed&#39;</span>,  
      <span class="dt">col =</span> iCol<span class="op">$</span>col)
  toPlot<span class="op">@</span>legend<span class="op">@</span>colortable =<span class="st"> </span><span class="kw">c</span>(<span class="ot">NA</span>,rCol<span class="op">$</span>plot)
  
  <span class="kw">map.new</span>(kentuckyCounty)
  <span class="kw">plot</span>(toPlot, <span class="dt">add=</span><span class="ot">TRUE</span>)
  <span class="kw">plot</span>(kMap, <span class="dt">add =</span> <span class="ot">TRUE</span>)
  
  <span class="kw">legendBreaks</span>(<span class="st">&#39;topleft&#39;</span>, rCol,  <span class="dt">bg =</span> <span class="st">&#39;white&#39;</span>)
}</code></pre></div>
<div id="fig:intensPlots" class="subfigures">
<table style="width:88%;">
<colgroup>
<col style="width: 44%" />
<col style="width: 44%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><figure>
<img src="figure/intensPlots-1.png" alt="a) 5000" style="width:100.0%" /><figcaption>a) 5000</figcaption>
</figure></td>
<td style="text-align: center;"><figure>
<img src="figure/intensPlots-2.png" alt="b) 6000" style="width:100.0%" /><figcaption>b) 6000</figcaption>
</figure></td>
</tr>
<tr class="even">
<td style="text-align: center;"><figure>
<img src="figure/intensPlots-3.png" alt="c) 7000" style="width:100.0%" /><figcaption>c) 7000</figcaption>
</figure></td>
<td style="text-align: center;"><figure>
<img src="figure/intensPlots-4.png" alt="d) 8000" style="width:100.0%" /><figcaption>d) 8000</figcaption>
</figure></td>
</tr>
<tr class="odd">
<td style="text-align: center;"><figure>
<img src="figure/intensPlots-5.png" alt="e) 10000" style="width:100.0%" /><figcaption>e) 10000</figcaption>
</figure></td>
<td style="text-align: center;"><figure>
<img src="figure/intensPlots-6.png" alt="f) 11000" style="width:100.0%" /><figcaption>f) 11000</figcaption>
</figure></td>
</tr>
<tr class="even">
<td style="text-align: center;"><figure>
<img src="figure/intensPlots-7.png" alt="g) 13000" style="width:100.0%" /><figcaption>g) 13000</figcaption>
</figure></td>
<td style="text-align: center;"><figure>
<img src="figure/intensPlots-8.png" alt="h) 16000" style="width:100.0%" /><figcaption>h) 16000</figcaption>
</figure></td>
</tr>
<tr class="odd">
<td style="text-align: center;"><figure>
<img src="figure/intensPlots-9.png" alt="i) 19000" style="width:100.0%" /><figcaption>i) 19000</figcaption>
</figure></td>
<td style="text-align: center;"><figure>
<img src="figure/intensPlots-10.png" alt="j) 22000" style="width:100.0%" /><figcaption>j) 22000</figcaption>
</figure></td>
</tr>
<tr class="even">
<td style="text-align: center;"><figure>
<img src="figure/intensPlots-11.png" alt="k) 26000" style="width:100.0%" /><figcaption>k) 26000</figcaption>
</figure></td>
<td style="text-align: center;"><figure>
<img src="figure/intensPlots-12.png" alt="l) 31000" style="width:100.0%" /><figcaption>l) 31000</figcaption>
</figure></td>
</tr>
<tr class="odd">
<td style="text-align: center;"><figure>
<img src="figure/intensPlots-13.png" alt="m) 36000" style="width:100.0%" /><figcaption>m) 36000</figcaption>
</figure></td>
<td style="text-align: center;"><figure>
<img src="figure/intensPlots-14.png" alt="n) 42000" style="width:100.0%" /><figcaption>n) 42000</figcaption>
</figure></td>
</tr>
<tr class="even">
<td style="text-align: center;"><figure>
<img src="figure/intensPlots-15.png" alt="o) 50000" style="width:100.0%" /><figcaption>o) 50000</figcaption>
</figure></td>
</tr>
</tbody>
</table>
<p><em>Figure 3</em>: rr</p>
</div>
<h1 id="multiple-datasets">Multiple datasets</h1>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(<span class="st">&#39;localEM&#39;</span>)
xvAll =<span class="st"> </span><span class="kw">lemXv</span>(
    <span class="dt">cases =</span> kentuckyCounty<span class="op">@</span>data[,<span class="kw">grep</span>(<span class="st">&quot;^count[[:digit:]]&quot;</span>, <span class="kw">names</span>(kentuckyCounty))],   
    <span class="dt">lemObjects =</span> xvKentucky<span class="op">$</span>smoothingMatrix,
    <span class="dt">ncores =</span> ncores, 
    <span class="dt">verbose =</span> <span class="ot">TRUE</span>,
    <span class="dt">path=</span><span class="st">&#39;cache&#39;</span>)</code></pre></div>
<pre><code>## using supplied smoothing matrix
## running local-EM for validation sets
## computing CV scores
## putting estimated risk in raster</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">matplot</span>(xvAll<span class="op">$</span>xv[,<span class="st">&#39;bw&#39;</span>]<span class="op">/</span><span class="dv">1000</span>, 
    xvAll<span class="op">$</span>xv[,<span class="op">-</span><span class="dv">1</span>], 
    <span class="dt">xlab=</span><span class="st">&#39;km&#39;</span>, <span class="dt">ylab=</span><span class="st">&#39;-log p&#39;</span>, 
    <span class="dt">type=</span><span class="st">&#39;l&#39;</span>, <span class="dt">lty=</span><span class="dv">1</span>, <span class="dt">log=</span><span class="st">&#39;x&#39;</span>,
    <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">15</span>) ) </code></pre></div>
<div id="fig:cvPlotAll" class="subfigures">
<table style="width:80%;">
<colgroup>
<col style="width: 80%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><figure>
<img src="figure/cvPlotAll-1.png" alt="a) cross validation scores" style="width:100.0%" /><figcaption>a) cross validation scores</figcaption>
</figure></td>
</tr>
</tbody>
</table>
<p><em>Figure 4</em>: cross validation scores</p>
</div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">kentuckyFinal =<span class="st"> </span><span class="kw">lemFinal</span>(
    <span class="dt">x=</span>xvAll,
    <span class="dt">counts=</span><span class="kw">paste</span>(<span class="st">&quot;count&quot;</span>, <span class="dv">2</span><span class="op">:</span><span class="dv">3</span>, <span class="dt">sep=</span><span class="st">&#39;&#39;</span>),
    <span class="dt">ncores =</span> <span class="dv">2</span>,
    <span class="dt">filename =</span> <span class="kw">file.path</span>(<span class="st">&#39;cache&#39;</span>, <span class="st">&#39;lemFinal.grd&#39;</span>),
    <span class="dt">verbose =</span> <span class="ot">TRUE</span>)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">Ssim =<span class="st"> </span><span class="kw">unique</span>(<span class="kw">gsub</span>(<span class="st">&quot; .*&quot;</span>, <span class="st">&quot;&quot;</span>, knitr<span class="op">::</span>opts_current<span class="op">$</span><span class="kw">get</span>()<span class="op">$</span>fig.subcap))

<span class="cf">for</span>(Dsim <span class="cf">in</span> Ssim) {
  <span class="kw">map.new</span>(kentuckyCounty)
  <span class="kw">plot</span>(kCases<span class="op">$</span>raster[[<span class="kw">paste</span>(<span class="st">&#39;relativeIntensity&#39;</span>, Dsim, <span class="dt">sep=</span><span class="st">&#39;&#39;</span>)]], 
      <span class="dt">col =</span> iCol<span class="op">$</span>col, <span class="dt">breaks =</span> iCol<span class="op">$</span>breaks, 
      <span class="dt">legend =</span> <span class="ot">FALSE</span>, 
      <span class="dt">add =</span> <span class="ot">TRUE</span>)
  <span class="kw">plot</span>(kMap, <span class="dt">add =</span> <span class="ot">TRUE</span>)
  
  
  
  <span class="kw">map.new</span>(kentuckyCounty)
  <span class="kw">plot</span>(kentuckyFinal[[<span class="kw">grep</span>(<span class="kw">paste</span>(<span class="st">&#39;[[:alpha:]]&#39;</span>,Dsim,<span class="st">&#39;$&#39;</span>,<span class="dt">sep=</span><span class="st">&#39;&#39;</span>), <span class="kw">names</span>(kentuckyFinal))[<span class="dv">1</span>]]], 
      <span class="dt">col =</span> iCol<span class="op">$</span>col, <span class="dt">breaks=</span>iCol<span class="op">$</span>breaks,
      <span class="dt">legend=</span><span class="ot">FALSE</span>,
      <span class="dt">add=</span><span class="ot">TRUE</span>)
  <span class="kw">plot</span>(kMap, <span class="dt">add =</span> <span class="ot">TRUE</span>)
  <span class="kw">legendBreaks</span>(<span class="st">&#39;topleft&#39;</span>, iCol)
  
}</code></pre></div>
<div id="fig:estPlotMult" class="subfigures">
<table style="width:88%;">
<colgroup>
<col style="width: 44%" />
<col style="width: 44%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><figure>
<img src="figure/estPlotMult-1.png" alt="a) 2 true" style="width:100.0%" /><figcaption>a) 2 true</figcaption>
</figure></td>
<td style="text-align: center;"><figure>
<img src="figure/estPlotMult-2.png" alt="b) 2 est" style="width:100.0%" /><figcaption>b) 2 est</figcaption>
</figure></td>
</tr>
<tr class="even">
<td style="text-align: center;"><figure>
<img src="figure/estPlotMult-3.png" alt="c) 3 true" style="width:100.0%" /><figcaption>c) 3 true</figcaption>
</figure></td>
<td style="text-align: center;"><figure>
<img src="figure/estPlotMult-4.png" alt="d) 3 est" style="width:100.0%" /><figcaption>d) 3 est</figcaption>
</figure></td>
</tr>
</tbody>
</table>
<p><em>Figure 5</em>: Simulation 2,3</p>
</div>
<h2 id="exceedance-probabilities">Exceedance Probabilities</h2>
<p>Exceedance probabilities are computed with the <code>excProb()</code> function to measure the uncertainty of the local-EM risk estimation. Bootstrapping is used to obtain these exceedance probabilities for the local-EM algorithm.</p>
<p>Specifically, under the assumption that disease events are a realisation from the background population and constant risk threshold, cases are bootstrapped and randomly aggregated to the counties. Using the same bandwidth as the observed data, the local-EM risk is then estimated for each of the bootstrapped data. Afterwards, exceedance probabilities are computed as the proportion of the observed risk estimate at least as large as the ones of the bootstrap data. Large exceedance probabilities are consistent with the risk being greater than the specified threshold.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">lemExcProb =<span class="st"> </span><span class="kw">excProb</span>(
    <span class="dt">lemEst =</span> lemRisk, 
    <span class="dt">lemObjects =</span> xvKentucky, 
    <span class="dt">threshold =</span> <span class="kw">c</span>(<span class="fl">1.25</span>, <span class="dv">2</span>), 
    <span class="dt">Nboot =</span> <span class="dv">20</span>, 
    <span class="dt">ncores =</span> ncores)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#exceedance probability maps</span>
pCol =<span class="st"> </span><span class="kw">colourScale</span>(lemExcProb, 
    <span class="dt">breaks =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="fl">0.2</span>, <span class="fl">0.8</span>, <span class="fl">0.95</span>, <span class="dv">1</span>), <span class="dt">style =</span> <span class="st">&#39;fixed&#39;</span>, 
    <span class="dt">col =</span> <span class="kw">c</span>(<span class="st">&#39;green&#39;</span>, <span class="st">&#39;yellow&#39;</span>, <span class="st">&#39;orange&#39;</span>, <span class="st">&#39;red&#39;</span>)
)                               

<span class="cf">for</span>(Dthreshold <span class="cf">in</span> <span class="kw">names</span>(lemExcProb)) {
  
  threshold =<span class="st"> </span><span class="kw">gsub</span>(<span class="st">&#39;threshold</span><span class="ch">\\</span><span class="st">.&#39;</span>, <span class="st">&#39;&#39;</span>, Dthreshold)
  <span class="kw">map.new</span>(kentuckyTract, 
      <span class="dt">mar =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>), 
      <span class="dt">main =</span> <span class="kw">paste</span>(<span class="st">&#39;Exceedance Probabilities, t = &#39;</span>, threshold, <span class="dt">sep =</span> <span class="st">&#39;&#39;</span>))
  <span class="kw">plot</span>(lemExcProb[[Dthreshold]], 
      <span class="dt">col =</span> pCol<span class="op">$</span>col, <span class="dt">breaks =</span> pCol<span class="op">$</span>breaks, 
      <span class="dt">legend =</span> <span class="ot">FALSE</span>, 
      <span class="dt">add =</span> <span class="ot">TRUE</span>)
  <span class="kw">plot</span>(kMap, <span class="dt">add =</span> <span class="ot">TRUE</span>)
  
  <span class="kw">legendBreaks</span>(<span class="st">&#39;topleft&#39;</span>, 
      <span class="dt">col =</span> pCol<span class="op">$</span>col, <span class="dt">breaks =</span> pCol<span class="op">$</span>breaks, 
      <span class="dt">title =</span> <span class="st">&#39;prob&#39;</span>, 
      <span class="dt">bg =</span> <span class="st">&#39;white&#39;</span>)
  
  <span class="kw">scaleBar</span>(kentuckyCounty, 
      <span class="dt">pos =</span> <span class="st">&#39;topleft&#39;</span>, 
      <span class="dt">inset =</span> <span class="kw">c</span>(<span class="fl">0.3</span>, <span class="fl">0.1</span>), 
      <span class="dt">bg =</span> <span class="st">&#39;white&#39;</span>)
}</code></pre></div>
<h2 id="references">References</h2>
<ol type="1">
<li><p>Nguyen P, Brown PE, Stafford J. Mapping cancer risk in southwestern Ontario with changing census boundaries. Biometrics. 2012; 68(4): 1229-37.</p></li>
<li><p>Besag J, York J, Mollie A. Bayesian image restoration, with two applications in spatial statistics. Ann Inst Statist Math. 1991; 43(1): 1-59.</p></li>
</ol>
</body>
</html>
